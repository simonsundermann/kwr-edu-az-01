#cloud-config
package_update: true
package_upgrade: true

write_files:
  - path: /usr/local/bin/robotics-postinstall.sh
    permissions: "0755"
    content: |
${robotics_postinstall_script}

  - path: /usr/local/bin/bootstrap.sh
    permissions: "0755"
    content: |
      #!/usr/bin/env bash
      set -euo pipefail
      exec > >(tee -a /var/log/bootstrap.log) 2>&1

      ADMIN_USER="${admin_username}"
      BASTION_CIDR="10.0.255.0/27"
      RDP_PORT="3389"

      apt_update() {
        apt-get update
      }

      apt_install() {
        DEBIAN_FRONTEND=noninteractive apt-get install -y "$@"
      }

      echo "=== [0/5] SSH hardening and AAD sudo ==="
      mkdir -p /etc/ssh/sshd_config.d
      cat >/etc/ssh/sshd_config.d/99-hardening.conf <<'EOF'
      PasswordAuthentication no
      PermitRootLogin no
      PubkeyAuthentication yes
      X11Forwarding no
      AllowTcpForwarding no
      ClientAliveInterval 300
      ClientAliveCountMax 2
      EOF
      systemctl restart ssh

      echo "%aad_admins ALL=(ALL) NOPASSWD:ALL" >/etc/sudoers.d/99-aad-admins
      chmod 0440 /etc/sudoers.d/99-aad-admins
      visudo -cf /etc/sudoers.d/99-aad-admins >/dev/null

      echo "=== [1/5] Base packages ==="
      apt_update
      apt_install --no-install-recommends \
        ufw fail2ban unattended-upgrades \
        curl ca-certificates gnupg lsb-release software-properties-common \
        git wget \
        xrdp xorgxrdp xfce4 xfce4-goodies dbus-x11 xterm
      dpkg-reconfigure -f noninteractive unattended-upgrades || true

      echo "=== [2/5] Firewall for Bastion access (SSH + RDP) ==="
      ufw --force reset
      ufw default deny incoming
      ufw default allow outgoing
      ufw allow from "$BASTION_CIDR" to any port 22 proto tcp
      ufw allow from "$BASTION_CIDR" to any port "$RDP_PORT" proto tcp
      ufw --force enable

      echo "=== [3/5] Configure and enable xRDP ==="
      adduser xrdp ssl-cert || true
      echo "startxfce4" >/etc/skel/.xsession
      if id "$ADMIN_USER" >/dev/null 2>&1; then
        echo "startxfce4" >"/home/$ADMIN_USER/.xsession"
        chown "$ADMIN_USER:$ADMIN_USER" "/home/$ADMIN_USER/.xsession"
        chmod 0644 "/home/$ADMIN_USER/.xsession"
      fi
      systemctl enable --now xrdp

      echo "=== [4/5] MOTD ==="
      cat >/etc/motd <<EOF
      Azure GPU Robotics Workstation ready.

      Access:
        - Use Azure Bastion SSH with Entra ID (AAD) from your Windows PC.
        - RDP via Bastion tunnel: VM port 3389 -> local port 53389.
        - Connect with mstsc to 127.0.0.1:53389.

      Manual post-install (recommended after first login):
        sudo /usr/local/bin/robotics-postinstall.sh

      Logs:
        /var/log/bootstrap.log
        /var/log/robotics-postinstall.log
      EOF

      echo "=== [5/5] Bootstrap complete ==="

runcmd:
  - /usr/local/bin/bootstrap.sh

final_message: "Bootstrap completed. Check /var/log/bootstrap.log"
